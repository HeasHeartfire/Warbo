<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title></title>
    <style type="text/css">
       .twitter-follow-button {
        position: absolute !important;
      }
    </style>
    
    <script data-main="config" src="requirejs/require.js"></script>

    <script type="text/javascript">
    var tileWidth = 64;
    var tileHeight = 32;
    require([
      'jsiso/canvas/Control',
      'jsiso/canvas/Input',
      'jsiso/img/load',
      'jsiso/json/load',
      'jsiso/tile/Field',
      'jsiso/pathfind/pathfind',
      'requirejs/domReady!'
    ],
    function(CanvasControl, CanvasInput, imgLoader, jsonLoader, TileField, pathfind) {

      // -- FPS --------------------------------
      window.requestAnimFrame = (function() {
        return window.requestAnimationFrame || 
        window.webkitRequestAnimationFrame  || 
        window.mozRequestAnimationFrame     || 
        window.oRequestAnimationFrame       ||  
        window.msRequestAnimationFrame      || 
        function(callback, element) {
          window.setTimeout(callback, 1000 / 60);
        };
      })();
      // ---------------------------------------


      function launch() {

        jsonLoader(['test5.json']).then(function(jsonResponse) {

          var images = [
            {
              graphics: ["img/tileset.png"],
              spritesheet: {
                width: jsonResponse[0].tilesets[0].tilewidth,
                height: jsonResponse[0].tilesets[0].tileheight,
                firstgid: jsonResponse[0].tilesets[0].firstgid,
                offsetX: 0,
                offsetY: 0
              }
            }
          ];

          imgLoader(images).then(function(imgResponse) {

            var tileEngine = new main(0, 0, jsonResponse[0].height, jsonResponse[0].width);
            var layouts = [];
            for(var i=0; i<jsonResponse[0].layers.length; i++) {
              layouts[i] = {
                layout: jsonResponse[0].layers[i].data,
                graphics: imgResponse[0].files,
                graphicsDictionary: imgResponse[0].dictionary,
                tileWidth: tileWidth,
                tileHeight: tileHeight,
                width: jsonResponse[0].layers[i].width,
                height: jsonResponse[0].layers[i].height
              };
            }
            tileEngine.init(layouts);
          });
        });
      }


      function main(x, y, xrange, yrange) {

        var mapLayers = [];

        var context = CanvasControl.create("canavas", tileWidth*14, tileHeight*14, {
          display: "block",
          marginLeft: "auto",
          marginRight: "auto"
        });
        
        function draw() {
          // context.clearRect(0, 0, CanvasControl().width, CanvasControl().height);
          for (var i = 0; i < 0 + yrange; i++) {
            for (var j = 0; j < 0 + xrange; j++) {
              mapLayers.map(function(layer) {
                layer.draw(i,j);
              });
            }
          }        
        }

        return {
          init: function(layers) {
            console.log(layers);
            for (var i = 0; i < layers.length; i++) {
              mapLayers[i] = new TileField(context, CanvasControl().height, CanvasControl().width);
              mapLayers[i].setup(layers[i]);
              // -- Flip and rotate to match the Tiled draw method --
              mapLayers[i].flip("horizontal");
              mapLayers[i].rotate("left");

              mapLayers[i].align("h-center", CanvasControl().width, xrange, 0);
              mapLayers[i].align("v-center", CanvasControl().height, yrange, 0);
              draw();
            }
            
          }
        };

      }

      launch();
    });
    </script>
  </head>
  <body>
  </body>
</html>